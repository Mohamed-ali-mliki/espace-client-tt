
<div class="dashboard-container">
  <!-- Header -->
  <header class="dashboard-header">
    <div class="header-left">
      <h1><i class="fas fa-tachometer-alt"></i> Tableau de Bord Client</h1>
      <p class="welcome-text">Bienvenue, {{ user?.prenom }} {{ user?.nom }}</p>
    </div>
    
    <div class="header-right">
      <div class="user-profile" (click)="ouvrirModalProfil()">
        <div class="avatar">
          <i class="fas fa-user"></i>
        </div>
        <div class="user-info">
          <span class="user-name">{{ user?.prenom }} {{ user?.nom }}</span>
          <span class="user-role">Client</span>
        </div>
        <i class="fas fa-chevron-down"></i>
      </div>
      
      <button class="btn btn-primary" (click)="ouvrirModalDemande()">
        <i class="fas fa-plus"></i> Nouvelle Demande
      </button>
    </div>
  </header>
  
  <!-- Cartes de Statistiques -->
  <section class="stats-section">
    <div class="row">
      <div class="col-md-3 col-sm-6">
        <div class="stat-card">
          <div class="stat-icon bg-primary">
            <i class="fas fa-wifi"></i>
          </div>
          <div class="stat-info">
            <h3>{{ stats.totalAbonnements }}</h3>
            <p>Abonnements</p>
          </div>
        </div>
      </div>
      
      <div class="col-md-3 col-sm-6">
        <div class="stat-card">
          <div class="stat-icon bg-success">
            <i class="fas fa-check-circle"></i>
          </div>
          <div class="stat-info">
            <h3>{{ stats.abonnementsActifs }}</h3>
            <p>Actifs</p>
          </div>
        </div>
      </div>
      
      <div class="col-md-3 col-sm-6">
        <div class="stat-card">
          <div class="stat-icon bg-warning">
            <i class="fas fa-tasks"></i>
          </div>
          <div class="stat-info">
            <h3>{{ stats.demandesEnCours }}</h3>
            <p>Demandes en cours</p>
          </div>
        </div>
      </div>
      
      <div class="col-md-3 col-sm-6">
        <div class="stat-card">
          <div class="stat-icon bg-info">
            <i class="fas fa-money-bill-wave"></i>
          </div>
          <div class="stat-info">
            <h3>{{ stats.depenseMensuelle }} DT</h3>
            <p>Dépense mensuelle</p>
          </div>
        </div>
      </div>
    </div>
  </section>
  
  <!-- Sections Principales -->
  <div class="row main-content">
    <!-- Abonnements Actifs -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h3><i class="fas fa-wifi"></i> Mes Abonnements</h3>
          <button class="btn btn-sm btn-outline-primary" (click)="allerVersAbonnements()">
            Voir tous <i class="fas fa-arrow-right"></i>
          </button>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Service</th>
                  <th>Type</th>
                  <th>Prix</th>
                  <th>Statut</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let abonnement of abonnements.slice(0, 3)">
                  <td>
                    <strong>{{ abonnement.nom }}</strong>
                    <small class="d-block text-muted">Renouv. {{ abonnement.dateRenouvellement }}</small>
                  </td>
                  <td>
                    <span class="badge" [ngClass]="getTypeBadgeClass(abonnement.type)">
                      {{ abonnement.type }}
                    </span>
                  </td>
                  <td><strong>{{ abonnement.prix }} DT</strong></td>
                  <td>
                    <span class="badge" [ngClass]="getStatutBadgeClass(abonnement.statut)">
                      {{ abonnement.statut }}
                    </span>
                  </td>
                  <td>
                    <div class="btn-group">
                      <button class="btn btn-sm btn-outline-info" 
                              (click)="modifierAbonnement(abonnement)">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button class="btn btn-sm btn-outline-danger" 
                              *ngIf="abonnement.statut === 'ACTIF'"
                              (click)="resilierAbonnement(abonnement.id)">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </td>
                </tr>
                <tr *ngIf="abonnements.length === 0">
                  <td colspan="5" class="text-center">Aucun abonnement trouvé</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Demandes Récentes -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h3><i class="fas fa-tasks"></i> Demandes Récentes</h3>
          <div class="header-actions">
            <select class="form-control form-control-sm" [(ngModel)]="filterStatut" (change)="currentPage = 1">
              <option value="TOUS">Tous les statuts</option>
              <option *ngFor="let statut of statutsDemande" [value]="statut">
                {{ statut }}
              </option>
            </select>
            <button class="btn btn-sm btn-outline-primary" (click)="allerVersDemandes()">
              Voir tous <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>N°</th>
                  <th>Titre</th>
                  <th>Type</th>
                  <th>Statut</th>
                  <th>Priorité</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let demande of demandesPaginees">
                  <td><small class="text-muted">{{ demande.numero }}</small></td>
                  <td>
                    <strong>{{ demande.titre }}</strong>
                    <small class="d-block text-muted">{{ formatDate(demande.dateCreation) }}</small>
                  </td>
                  <td>{{ demande.type }}</td>
                  <td>
                    <span class="badge" [ngClass]="getStatutBadgeClass(demande.statut)">
                      {{ demande.statut }}
                    </span>
                  </td>
                  <td>
                    <span class="badge" [ngClass]="getPrioriteBadgeClass(demande.priorite)">
                      {{ demande.priorite }}
                    </span>
                  </td>
                  <td>
                    <div class="btn-group">
                      <button class="btn btn-sm btn-outline-info" title="Voir">
                        <i class="fas fa-eye"></i>
                      </button>
                      <button class="btn btn-sm btn-outline-danger" title="Supprimer"
                              (click)="supprimerDemande(demande.id)">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>
                <tr *ngIf="demandesFiltrees.length === 0">
                  <td colspan="6" class="text-center">Aucune demande trouvée</td>
                </tr>
              </tbody>
            </table>
            
            <!-- Pagination -->
            <div class="pagination" *ngIf="totalPages > 1">
              <button class="btn btn-sm" 
                      [disabled]="currentPage === 1"
                      (click)="changerPage(currentPage - 1)">
                <i class="fas fa-chevron-left"></i>
              </button>
              
              <span class="page-info">
                Page {{ currentPage }} sur {{ totalPages }}
              </span>
              
              <button class="btn btn-sm"
                      [disabled]="currentPage === totalPages"
                      (click)="changerPage(currentPage + 1)">
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Actions Rapides -->
  <section class="quick-actions">
    <h3><i class="fas fa-bolt"></i> Actions Rapides</h3>
    <div class="row">
      <div class="col-md-3 col-sm-6">
        <div class="action-card" (click)="ouvrirModalDemande()">
          <div class="action-icon bg-primary">
            <i class="fas fa-plus-circle"></i>
          </div>
          <h4>Nouvelle Demande</h4>
          <p>Créer une nouvelle demande de support</p>
        </div>
      </div>
      
      <div class="col-md-3 col-sm-6">
        <div class="action-card" (click)="allerVersAbonnements()">
          <div class="action-icon bg-success">
            <i class="fas fa-chart-line"></i>
          </div>
          <h4>Améliorer Abonnement</h4>
          <p>Changer votre offre actuelle</p>
        </div>
      </div>
      
      <div class="col-md-3 col-sm-6">
        <div class="action-card" (click)="ouvrirModalProfil()">
          <div class="action-icon bg-info">
            <i class="fas fa-user-edit"></i>
          </div>
          <h4>Modifier Profil</h4>
          <p>Mettre à jour vos informations</p>
        </div>
      </div>
      
      <div class="col-md-3 col-sm-6">
        <div class="action-card" routerLink="/subscriptions">
          <div class="action-icon bg-warning">
            <i class="fas fa-file-invoice-dollar"></i>
          </div>
          <h4>Consulter Factures</h4>
          <p>Voir votre historique de paiement</p>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- Modal Nouvelle Demande -->
<div class="modal-overlay" *ngIf="showDemandeModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3><i class="fas fa-plus-circle"></i> Nouvelle Demande</h3>
      <button class="close-btn" (click)="fermerModalDemande()">&times;</button>
    </div>
    
    <div class="modal-body">
      <form [formGroup]="demandeForm" (ngSubmit)="creerDemande()">
        <div class="form-group">
          <label>Type de Demande *</label>
          <select class="form-control" formControlName="type">
            <option value="">Sélectionner un type</option>
            <option *ngFor="let type of typesDemande" [value]="type">{{ type }}</option>
          </select>
          <div *ngIf="demandeForm.get('type')?.invalid && demandeForm.get('type')?.touched" 
               class="error-message">
            Le type est requis
          </div>
        </div>
        
        <div class="form-group">
          <label>Titre *</label>
          <input type="text" class="form-control" formControlName="titre" 
                 placeholder="Ex: Problème de connexion fibre">
          <div *ngIf="demandeForm.get('titre')?.invalid && demandeForm.get('titre')?.touched" 
               class="error-message">
            Le titre doit avoir au moins 5 caractères
          </div>
        </div>
        
        <div class="form-group">
          <label>Description *</label>
          <textarea class="form-control" formControlName="description" rows="4"
                    placeholder="Décrivez votre demande en détail..."></textarea>
          <div *ngIf="demandeForm.get('description')?.invalid && demandeForm.get('description')?.touched" 
               class="error-message">
            La description doit avoir au moins 10 caractères
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-6">
            <div class="form-group">
              <label>Priorité</label>
              <select class="form-control" formControlName="priorite">
                <option value="BASSE">Basse</option>
                <option value="NORMALE">Normale</option>
                <option value="HAUTE">Haute</option>
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group">
              <label>Abonnement concerné</label>
              <select class="form-control" formControlName="abonnementId">
                <option value="">Sélectionner un abonnement</option>
                <option *ngFor="let abonnement of abonnements" [value]="abonnement.id">
                  {{ abonnement.nom }}
                </option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="fermerModalDemande()">
            Annuler
          </button>
          <button type="submit" class="btn btn-primary" [disabled]="!demandeForm.valid">
            <i class="fas fa-paper-plane"></i> Envoyer la Demande
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Modifier Profil -->
<div class="modal-overlay" *ngIf="showProfilModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3><i class="fas fa-user-edit"></i> Modifier le Profil</h3>
      <button class="close-btn" (click)="fermerModalProfil()">&times;</button>
    </div>
    
    <div class="modal-body">
      <form [formGroup]="editProfilForm" (ngSubmit)="sauvegarderProfil()">
        <div class="row">
          <div class="col-md-6">
            <div class="form-group">
              <label>Nom *</label>
              <input type="text" class="form-control" formControlName="nom">
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group">
              <label>Prénom *</label>
              <input type="text" class="form-control" formControlName="prenom">
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label>Email *</label>
          <input type="email" class="form-control" formControlName="email">
        </div>
        
        <div class="form-group">
          <label>Téléphone</label>
          <input type="tel" class="form-control" formControlName="telephone">
        </div>
        
        <div class="form-group">
          <label>Adresse</label>
          <input type="text" class="form-control" formControlName="adresse">
        </div>
        
        <div class="row">
          <div class="col-md-6">
            <div class="form-group">
              <label>Ville</label>
              <input type="text" class="form-control" formControlName="ville">
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group">
              <label>Code Postal</label>
              <input type="text" class="form-control" formControlName="codePostal">
            </div>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="fermerModalProfil()">
            Annuler
          </button>
          <button type="submit" class="btn btn-primary" [disabled]="!editProfilForm.valid">
            <i class="fas fa-save"></i> Sauvegarder
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Modifier Abonnement -->
<div class="modal-overlay" *ngIf="showAbonnementModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3><i class="fas fa-edit"></i> Modifier Abonnement</h3>
      <button class="close-btn" (click)="showAbonnementModal = false">&times;</button>
    </div>
    
    <div class="modal-body">
      <form [formGroup]="editAbonnementForm" (ngSubmit)="mettreAJourAbonnement()">
        <div class="form-group">
          <label>Type *</label>
          <select class="form-control" formControlName="type">
            <option value="FIBRE">Fibre</option>
            <option value="ADSL">ADSL</option>
            <option value="MOBILE">Mobile</option>
            <option value="FIXE">Fixe</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Prix (DT) *</label>
          <input type="number" class="form-control" formControlName="prix" min="0" step="0.01">
        </div>
        
        <div class="form-group">
          <label>Date de renouvellement *</label>
          <input type="date" class="form-control" formControlName="dateRenouvellement">
        </div>
        
        <div class="form-group">
          <label>Statut *</label>
          <select class="form-control" formControlName="statut">
            <option value="ACTIF">Actif</option>
            <option value="EN_ATTENTE">En attente</option>
            <option value="RESILIE">Résilié</option>
          </select>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="showAbonnementModal = false">
            Annuler
          </button>
          <button type="submit" class="btn btn-primary" [disabled]="!editAbonnementForm.valid">
            <i class="fas fa-save"></i> Mettre à jour
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
